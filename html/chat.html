<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link href="../css/style.css" rel="stylesheet" type="text/css">
    <link href="../css/chat.css" rel="stylesheet" type="text/css">
  </head>
  <body>
    <nav id="desktop-nav">
        <div class="top-bar">
          <a href="home.html" class="logo">
            <img src="/assets/mokesell.png" alt="MokeSell">
          </a>
          <div class="search-bar">
            <img src="/assets/search.png" alt="search-icon" class="search-icon">
            <input type="text" placeholder="Search..." class="search">
            <a href="camera.html" class="camera">
              <button class="camera-btn">
                <img src="/assets/camera.png" alt="camera-icon">
              </button>
            </a>
          </div>      
          <div class="icons">
            <a href="cart.html" class="cart">
              <button class="cart-btn">
                <img src="/assets/cart.png" alt="cart-icon">
              </button>
            </a>
            <a href="chat.html" class="chat">
              <button class="chat-btn">
                <img src="/assets/chat.png" alt="chat-icon">
              </button>
            </a>
            <a href="profile.html" class="profile">
              <button class="profile-btn">
                <img src="/assets/QX.png" alt="profile-icon">
              </button>
            </a>
          </div>
        </div>
    </nav>
    
    <div class="chat-container">
        <div class="sidebar">
            <ul class="chat-list">
              <a href="chat.html" class="chat-section">
                <button class="convo">
                  <img src="/assets/auther.png" alt="auther-icon">
                  <div class="chat-info">
                    <li>@auther_03</li>
                    <li id="listingTitle"><strong>Club Shirts Cute</strong></li>
                    <li class="light-text">Start chatting...</li>
                  </div>
                </button>
              </a>
            </ul>
        </div>
        <div class="chat-section">
          <div class="profile-info">
            <img src="/assets/auther.png" alt="auther-icon">
            <h4>@auther_03</h4>
            <img src="/assets/seller-setting.png" alt="seller-setting-icon" class="seller-setting-icon">
            <hr>
          </div>
          <hr>

          <div class="listing-selected">
            <img src="/assets/tee.jpeg" alt="Suggested product 1" class="listing-img">
            <div class="product-info">
              <p>Club Shirts Cute<p>
                <div id="listingPrice">S$13</div>
                <!-- <div id="listingDescription">Product Description</div> -->
                <div class="buy-actions">
                  <a href="buy.html" class="chat">
                    <button class="buy-btn">Buy</button>
                  </a>
                  <a href="cart.html" class="chat">
                    <button class="add-to-cart-btn">Add to Cart</button>
                  </a>
                </div>          
            </div>
          </div>
          
        

          <div class="messages" id="messages">
              <!-- msgs will appear here -->
          </div>
          <div class="input-container">
              <input type="text" id="messageInput" placeholder="Start chatting...">
              <button id="sendMessageButton">Send</button>
          </div>
        </div>
    </div>
    
    <script type="module">
      import { sendMessage, listenForMessages, resetBotResponseFlag } from '../js/chat.js';

      const messageInput = document.getElementById('messageInput');
      const sendMessageButton = document.getElementById('sendMessageButton');
      const messagesDiv = document.getElementById('messages');
      const listingTitle = document.getElementById('listingTitle');
      const listingPrice = document.getElementById('listingPrice');
      const listingDescription = document.getElementById('listingDescription');

      const productName = listingTitle.textContent.trim();
      // send msg when button is clicked
      sendMessageButton.addEventListener('click', () => {
          const message = messageInput.value.trim();
          if (message) {
              sendMessage(productName, message, 'user');  // send msg to Firebase
              messageInput.value = '';  // clear input after sending
              resetBotResponseFlag();   
          }
      });

      // listen for new msgs in real-time
      listenForMessages(productName, (messages) => {
          messagesDiv.innerHTML = '';  // clear existing messages
          messages.forEach((messageData) => {
              const messageDiv = document.createElement('div');
              messageDiv.classList.add('message', messageData.sender === 'user' ? 'user' : 'other');
              messageDiv.textContent = `${messageData.sender}: ${messageData.message}`;
              messagesDiv.appendChild(messageDiv);
          });
          messagesDiv.scrollTop = messagesDiv.scrollHeight;  // scroll to latest message
      });

      sendMessageButton.addEventListener('click', () => {
        const message = messageInput.value.trim();
        if (message) {
            sendMessage(listingId, message, 'user');  // send msg from user
            messageInput.value = '';  // clear input field after sending
            resetBotResponseFlag();  
        }
    });

      // static for now, will change
      // listingTitle.textContent = "Amazing Product!";
      // listingPrice.textContent = "$100";
      // listingDescription.textContent = "This is a great product! Get it now while stock lasts.";
    </script>
    <script type="module" src="../js/chat.js"></script>
    </body>
</html>